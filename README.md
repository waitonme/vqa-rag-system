# VQA RAG System

OpenWebUI νΈν™ PDF λ¬Έμ„ λ¶„μ„ λ° RAG (Retrieval-Augmented Generation) μ‹μ¤ν…μ…λ‹λ‹¤. 
Visual Question Answering (VQA) κΈ°λ¥μ„ ν¬ν•¨ν•μ—¬ ν…μ¤νΈμ™€ μ΄λ―Έμ§€κ°€ ν¬ν•¨λ PDF λ¬Έμ„λ¥Ό λ¶„μ„ν•κ³  μ§λ¬Έμ— λ‹µλ³€ν•  μ μμµλ‹λ‹¤.

## π—οΈ μ‹μ¤ν… μ•„ν‚¤ν…μ²

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚   OpenWebUI     β”‚β”€β”€β”€β–¶β”‚   API Server    β”‚β”€β”€β”€β–¶β”‚  Model Server   β”‚
β”‚  (Frontend)     β”‚    β”‚  (Port: 8000)   β”‚    β”‚  (Port: 8001)   β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                              β”‚                         β”‚
                              β–Ό                         β–Ό
                      β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                      β”‚  Models Client  β”‚    β”‚ GPU Models      β”‚
                      β”‚  (Wrapper)      β”‚    β”‚ - Text LLM      β”‚
                      β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”    β”‚ - VQA Model     β”‚
                              β”‚              β”‚ - Embedder      β”‚
                              β–Ό              β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                      β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                      β”‚   Utilities     β”‚
                      β”‚ - PDF Parser    β”‚
                      β”‚ - Text Chunker  β”‚
                      β”‚ - Debug Tools   β”‚
                      β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

## π“ νμΌλ³„ μ—­ν• 

### π API μ„λ²„ κ³„μΈµ

#### `api_server.py` - λ©”μΈ API μ„λ²„
- **μ—­ν• **: OpenWebUI νΈν™ RESTful API μ„λ²„
- **κΈ°λ¥**:
  - PDF νμΌ μ—…λ΅λ“ λ° μ²λ¦¬ (`/v1/files/`, `/v1/process`)
  - μ±„ν… μ™„λ£ API (`/v1/chat/completions`)
  - μ¤νΈλ¦¬λ° μ‘λ‹µ μ§€μ›
  - λ‹¤μ¤‘ λ¬Έμ„ RAG μ²λ¦¬
  - μ΄λ―Έμ§€ + ν…μ¤νΈ νΌν•© μ§μμ‘λ‹µ
- **ν¬νΈ**: 8000
- **μμ΅΄μ„±**: `models_client.py`, `utils.py`, `debug_chunk.py`

#### `model_server.py` - GPU λ¨λΈ μ¶”λ΅  μ„λ²„
- **μ—­ν• **: GPUμ—μ„ μ‹¤ν–‰λλ” AI λ¨λΈλ“¤μ μ¶”λ΅  μ„λ²„
- **κΈ°λ¥**:
  - ν…μ¤νΈ μ„λ² λ”© μƒμ„± (`/embed`)
  - ν…μ¤νΈ μƒμ„± (`/text/generate`)
  - VQA (Visual Question Answering) (`/vqa/generate`)
  - λ¨λΈ μƒνƒ ν™•μΈ (`/health`)
- **ν¬νΈ**: 8001
- **λ΅λ“ λ¨λΈ**: 
  - `jhgan/ko-sroberta-multitask` (μ„λ² λ”©)
  - `naver-hyperclovax/HyperCLOVAX-SEED-Text-Instruct-1.5B` (ν…μ¤νΈ μƒμ„±)
  - `naver-hyperclovax/HyperCLOVAX-SEED-Vision-Instruct-3B` (VQA)

### π”— ν΄λΌμ΄μ–ΈνΈ κ³„μΈµ

#### `models_client.py` - λ¨λΈ μ„λ²„ ν΄λΌμ΄μ–ΈνΈ
- **μ—­ν• **: API μ„λ²„μ™€ λ¨λΈ μ„λ²„ κ°„μ ν†µμ‹  μΈν„°νμ΄μ¤
- **μ£Όμ” ν΄λμ¤**:
  - `ModelServerClient`: HTTP ν†µμ‹  ν΄λΌμ΄μ–ΈνΈ
  - `VQARAGModelWrapper`: κΈ°μ΅΄ μΈν„°νμ΄μ¤ νΈν™μ„± μ μ§€
- **κΈ°λ¥**:
  - λ¨λΈ μ„λ²„ API νΈμ¶
  - μ΄λ―Έμ§€ λ°°μΉ μ²λ¦¬
  - μ„λ² λ”© κΈ°λ° μ μ‚¬λ„ κ²€μƒ‰
  - λ¬Έμ„λ³„ RAG μ²λ¦¬

### π› οΈ μ ν‹Έλ¦¬ν‹° κ³„μΈµ

#### `utils.py` - ν•µμ‹¬ μ ν‹Έλ¦¬ν‹° ν•¨μλ“¤
- **μ—­ν• **: ν…μ¤νΈ μ²λ¦¬, PDF νμ‹±, AI λ¨λΈ μΈν„°νμ΄μ¤
- **μ£Όμ” ν•¨μ**:
  - `split_text_into_chunks()`: ν† ν° κΈ°λ° ν…μ¤νΈ μ²­ν‚Ή
  - `simple_parse()`: PDFμ—μ„ ν…μ¤νΈμ™€ μ΄λ―Έμ§€ μ¶”μ¶
  - `hf_generate_response()`: HuggingFace λ¨λΈ ν…μ¤νΈ μƒμ„±
  - `vqa_generate_response()`: VQA λ¨λΈ μ΄λ―Έμ§€ λ¶„μ„
  - `clean_text()`: ν…μ¤νΈ μ •λ¦¬ λ° μ „μ²λ¦¬
  - `extract_assistant_response()`: λ¨λΈ μ‘λ‹µ νμ‹±

#### `debug_chunk.py` - λ””λ²„κΉ… λ„κµ¬
- **μ—­ν• **: μ²­ν¬ λ¶„μ„ λ° λ””λ²„κΉ… μ§€μ›
- **κΈ°λ¥**:
  - `print_chunk_debug()`: μ „μ²΄ μ²­ν¬ λ‚΄μ© μ¶λ ¥
  - `detect_debug_command()`: λ””λ²„κΉ… λ…λ Ήμ–΄ κ°μ§€
- **μ‚¬μ©λ²•**: μ±„ν…μ—μ„ "μ²­ν¬ μ¶λ ¥" λλ” "print chunk" μ…λ ¥

#### `visualization.py` - μ„±λ¥ λ¶„μ„ λ° μ‹κ°ν™”
- **μ—­ν• **: λ¨λΈ ν‰κ°€ κ²°κ³Ό μ‹κ°ν™” λ° λ¶„μ„
- **κΈ°λ¥**:
  - λ¨λΈλ³„ μ„±λ¥ λΉ„κµ μ°¨νΈ
  - PDF νμΌλ³„ μ„±λ¥ λ¶„μ„
  - μΉ΄ν…κ³ λ¦¬λ³„ μ„±λ¥ λ¶„μ„
  - μΆ…ν•© μ”μ•½ λ³΄κ³ μ„ μƒμ„±
- **μ¶λ ¥**: PNG μ°¨νΈ, ν…μ¤νΈ μ”μ•½

## π€ μ‹μ‘ν•κΈ°

### 1. ν™κ²½ μ„¤μ •
```bash
# μμ΅΄μ„± μ„¤μΉ
pip install -r requirements.txt

# NLTK λ°μ΄ν„° λ‹¤μ΄λ΅λ“ (μµμ΄ 1ν)
python -c "import nltk; nltk.download('punkt')"
```

### 2. μ„λ²„ μ‹μ‘

**Step 1: λ¨λΈ μ„λ²„ μ‹μ‘ (GPU ν•„μ”)**
```bash
python model_server.py
```

**Step 2: API μ„λ²„ μ‹μ‘**
```bash
python api_server.py
```

### 3. OpenWebUI μ—°κ²°
- OpenWebUIμ—μ„ μƒ λ¨λΈ μ¶”κ°€
- Base URL: `http://localhost:8000`
- API Key: `test-api-key` λλ” `your-api-key-here`

## π”§ μ‚¬μ©λ²•

### 1. PDF λ¬Έμ„ μ—…λ΅λ“
- OpenWebUIμ—μ„ PDF νμΌμ„ μ—…λ΅λ“
- μλ™μΌλ΅ ν…μ¤νΈ μ¶”μ¶ λ° μ²­ν‚Ή
- μ΄λ―Έμ§€ λ¶„μ„ (λ°±κ·ΈλΌμ΄λ“ μ²λ¦¬)

### 2. μ§λ¬Έν•κΈ°
```
μ΄ λ¬Έμ„μ μ£Όμ” λ‚΄μ©μ€ λ¬΄μ—‡μΈκ°€μ”?
νΉμ • μ •λ³΄λ¥Ό μ°Ύμ•„μ£Όμ„Έμ”
μ΄λ―Έμ§€μ— λ€ν•΄ μ„¤λ…ν•΄μ£Όμ„Έμ”
```

### 3. λ””λ²„κΉ…
```
μ²­ν¬ μ¶λ ¥    # μ²λ¦¬λ μ²­ν¬λ“¤μ„ ν™•μΈ
print chunk  # μμ–΄ λ…λ Ήμ–΄
```

## π“ μ§€μ›ν•λ” λ¨λΈλ“¤

| λ¨λΈ ID | μ„¤λ… |
|---------|------|
| `text_only_rag` | ν…μ¤νΈλ§ μ²λ¦¬ν•λ” RAG |
| `vqa_rag` | ν…μ¤νΈ + μ΄λ―Έμ§€ VQA RAG |
| `vqa_rag_cag` | κ°μ„ λ VQA RAG |
| `async_vqa_rag_cag` | λΉ„λ™κΈ° μ²λ¦¬ VQA RAG |

## π― μ£Όμ” νΉμ§•

- **OpenWebUI μ™„μ „ νΈν™**: ν‘μ¤€ OpenAI API ν•μ‹ μ§€μ›
- **λ‹¤μ¤‘ λ¬Έμ„ μ²λ¦¬**: μ—¬λ¬ PDF λ™μ‹ λ¶„μ„
- **μ‹¤μ‹κ°„ μ΄λ―Έμ§€ λ¶„μ„**: λ°±κ·ΈλΌμ΄λ“ λ°°μΉ μ²λ¦¬
- **μ¤νΈλ¦¬λ° μ‘λ‹µ**: μ‹¤μ‹κ°„ λ‹µλ³€ μƒμ„±
- **λ””λ²„κΉ… μ§€μ›**: μ²­ν¬ λ¶„μ„ λ° μƒνƒ ν™•μΈ
- **GPU λ¶„λ¦¬**: λ¨λΈ μ„λ²„ λ³„λ„ μ΄μμΌλ΅ ν™•μ¥μ„± ν™•λ³΄

## π” API μ—”λ“ν¬μΈνΈ

### API μ„λ²„ (Port 8000)
- `POST /v1/chat/completions` - μ±„ν… μ™„λ£
- `POST /v1/files/` - νμΌ μ—…λ΅λ“
- `PUT /v1/process` - λ¬Έμ„ μ²λ¦¬
- `GET /v1/status` - μ‹μ¤ν… μƒνƒ
- `GET /v1/models` - λ¨λΈ λ©λ΅

### λ¨λΈ μ„λ²„ (Port 8001)
- `POST /embed` - ν…μ¤νΈ μ„λ² λ”©
- `POST /text/generate` - ν…μ¤νΈ μƒμ„±
- `POST /vqa/generate` - VQA μƒμ„±
- `GET /health` - λ¨λΈ μƒνƒ

## π”§ μ„¤μ •

### GPU λ©”λ¨λ¦¬ ν• λ‹Ή
- GPU 1: Text λ¨λΈ (1.5B νλΌλ―Έν„°)
- GPU 3: VQA λ¨λΈ (3B νλΌλ―Έν„°)
- GPU 0: μ„λ² λ”© λ¨λΈ (μλ™ ν• λ‹Ή)

### ν™κ²½ λ³€μ
```bash
export CUDA_VISIBLE_DEVICES=0,1,3  # μ‚¬μ©ν•  GPU μ„¤μ •
```

## π“ μ„±λ¥ λ¨λ‹ν„°λ§

`visualization.py`λ¥Ό μ‚¬μ©ν•μ—¬ μ„±λ¥ λ¶„μ„:
```bash
python visualization.py
```

μƒμ„±λλ” λ¶„μ„ μ°¨νΈ:
- λ¨λΈλ³„ μ„±λ¥ λΉ„κµ
- νμΌλ³„ μ²λ¦¬ μ„±λ¥
- μΉ΄ν…κ³ λ¦¬λ³„ λ¶„μ„
- μΆ…ν•© μ”μ•½ λ³΄κ³ μ„

## π› λ¬Έμ  ν•΄κ²°

### μΌλ°μ μΈ λ¬Έμ λ“¤
1. **λ¨λΈ μ„λ²„ μ—°κ²° μ‹¤ν¨**: 
   - `model_server.py`κ°€ λ¨Όμ € μ‹¤ν–‰λμ—λ”μ§€ ν™•μΈ
   - GPU λ©”λ¨λ¦¬ λ¶€μ΅± ν™•μΈ

2. **PDF μ²λ¦¬ μ‹¤ν¨**:
   - νμΌ ν¬κΈ° λ° ν•μ‹ ν™•μΈ
   - μ„μ‹ νμΌ κ²½λ΅ κ¶ν• ν™•μΈ

3. **μ΄λ―Έμ§€ λ¶„μ„ λλ¦Ό**:
   - λ°±κ·ΈλΌμ΄λ“ μ²λ¦¬ μ§„ν–‰ μƒν™© ν™•μΈ
   - GPU λ©”λ¨λ¦¬ μ‚¬μ©λ‰ ν™•μΈ

### λ΅κ·Έ ν™•μΈ
- API μ„λ²„: μ”μ²­λ³„ μ²λ¦¬ μ‹κ°„ λ΅κΉ…
- λ¨λΈ μ„λ²„: λ¨λΈ λ΅λ”© λ° μ¶”λ΅  μƒνƒ
- μ‹μ¤ν… μƒνƒ: `/v1/status` μ—”λ“ν¬μΈνΈ ν™μ©

## π“ λΌμ΄μ„Όμ¤

μ΄ ν”„λ΅μ νΈλ” MIT λΌμ΄μ„Όμ¤λ¥Ό λ”°λ¦…λ‹λ‹¤. 